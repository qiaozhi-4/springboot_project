<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>你的项目</title>
    <!--添加Bootstrap和fontawesome的样式-->
    <link th:href="@{/css/theme-chalk-2.15.7.css}" href="../../static/css/theme-chalk-2.15.7.css" rel="stylesheet"/>
    <link th:href="@{/css/bootstrap.css}" href="../../static/css/bootstrap.css" rel="stylesheet"/>
    <!-- 布局容器 -->
    <link th:href="@{/css/container.css}" href="../../static/css/container.css" rel="stylesheet"/>
    <link th:href="@{/css/admin.css}" href="../../static/css/user.css" rel="stylesheet"/>
    <!-- 布局 -->
    <link th:href="@{/css/layout.css}" href="../../static/css/layout.css" rel="stylesheet"/>
    <!-- 下拉菜单按钮样式 -->
    <link th:href="@{/css/mycss1.css}" href="../../static/css/mycss1.css" rel="stylesheet"/>
</head>
<body>

<div id="app">
    <!--主体布局-->
    <el-container>

        <!-- 头部 -->
        <el-header id="admin-el-header" style="height: 300px;">
            <el-row type="flex" justify="space-around">
                <el-col :span="5" style="position: relative;">
                    <div class="grid-content admin-el-header-top">
                        <el-avatar
                                src="https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png"></el-avatar>
                        <div class="top-name">
                            <span>admin</span>
                        </div>
                    </div>
                </el-col>
            </el-row>
        </el-header>

        <!-- 主体部分 -->
        <el-main width="1500px" style="background-color: white">
            <el-row type="flex" justify="space-around">
                <el-col :span="5" class="main-navigation-bar">
                    <el-menu :default-active="activeIndex" class="el-menu-demo" mode="horizontal"
                             @select="handleSelect">
                        <el-menu-item index="1">
                            <el-link :href="'userInfo.html'" :underline="false">用户信息</el-link>
                        </el-menu-item>
                        <el-menu-item index="2">
                            <el-link :href="'userIndex.html'" :underline="false">历史记录</el-link>
                        </el-menu-item>
                        <el-menu-item index="3">
                            <el-link :href="'userCollect.html'" :underline="false">我的收藏</el-link>
                        </el-menu-item>
                    </el-menu>
                </el-col>
            </el-row>
            <el-row type="flex" justify="space-around">
                <el-col :span="8">
                    <el-form ref="form" :model="sizeForm" label-width="80px" size="mini">
                        <el-form-item label="账号">
                            <el-input v-model="sizeForm.username" disabled>
                            </el-input>
                        </el-form-item>
                        <el-form-item label="昵称">
                            <el-input v-model="sizeForm.name"></el-input>
                        </el-form-item>
                        <el-form-item label="性别">
                            <div style="text-align: left;">
                                <template>
                                    <el-radio v-model="sizeForm.sex" label="男">男</el-radio>
                                    <el-radio v-model="sizeForm.sex" label="女">女</el-radio>
                                </template>
                            </div>
                        </el-form-item>
                        <el-form-item label="生日">
                            <el-col :span="11">
                                <el-date-picker type="date" placeholder="选择日期" v-model="sizeForm.birthday"
                                                style="width: 100%;"></el-date-picker>
                            </el-col>
                        </el-form-item>
                        <el-form-item label="邮箱">
                            <el-input v-model="sizeForm.email" placeholder="你还未绑定邮箱"></el-input>
                        </el-form-item>
                        <el-form-item label="省份">
                            <el-select @change="change0" v-model="address.value0" clearable placeholder="请选择省份">
                                <el-option v-for="item in address.options0" :key="item.value" :label="item.label" :value="item.value"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="城市">
                            <el-select @change="change1" v-model="address.value1" clearable placeholder="请选择城市">
                                <el-option v-for="item in address.options1" :key="item.value" :label="item.label" :value="item.value"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="区县">
                            <el-select @change="change2" v-model="address.value2" clearable placeholder="请选择区/县">
                                <el-option v-for="item in address.options2" :key="item.value" :label="item.label" :value="item.value"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="街道">
                            <el-select v-model="address.value3" clearable placeholder="请选择区/县">
                                <el-option v-for="item in address.options3" :key="item.value" :label="item.label" :value="item.value"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="详细地址">
                            <el-input style="width: 400px;" placeholder="详细地址" v-model="address.value4" clearable></el-input>
                        </el-form-item>

                        <el-button type="primary" @click="showAddress(1)">查看地址</el-button>
                        <el-form-item size="large">
                            <el-button type="primary" @click="onSubmit">修改</el-button>
                        </el-form-item>
                    </el-form>
                </el-col>
            </el-row>
        </el-main>

        <!-- 底部部分 -->
        <el-footer>
            <span style="color: white">底部</span>
        </el-footer>

    </el-container>

</div>

<!--js脚本-->
<script th:src="@{/js/vue-2.6.14.min.js}" src="../../static/js/vue-2.6.14.min.js"></script>
<script th:src="@{/js/vue-router.js}" src="../../static/js/vue-router.js"></script>
<script th:src="@{/js/axios-0.26.js}" src="../../static/js/axios-0.26.js"></script>
<script th:src="@{/js/element-ui-2.15.7.js}" src="../../static/js/element-ui-2.15.7.js"></script>
<script th:src="@{/js/echarts.min.js}" src="../../static/js/echarts.min.js"></script>
<script th:src="@{/js/video-vue.js}" src="../../static/js/video-vue.js"></script>
<script th:src="@{/js/video.min.js}" src="../../static/js/video.min.js"></script>
<script th:inline="javascript">

    // 配置Axios，设置baseURL会自动拼接
    const axiosInstance = axios.create({
        baseURL: 'http://localhost:8081/api/', // http://localhost:8081/api/address/parent/0
        timeout: 3000,
        headers: {'X-Custom-Header': 'your-project'}
    })

    // 从缓存或者网络中获取全国地址的数据
    const getAddressFromCacheOrNetwork = pid => new Promise((resolve, reject) => {
        globalThis.cache = globalThis.cache || {}
        if (globalThis.cache[`${pid}`]) {
            resolve(globalThis.cache[`${pid}`])
            return
        }
        axiosInstance.get(`address/parent/${pid}`)
            .then(resp => {
                const data = resp.data
                globalThis.cache[`${pid}`] = data
                resolve(data)
            })
            .catch(err => reject(err))
    })

    // 第一种方式需要用到：
    const mapDataToAddress = data => data.map(v => ({
        label: v.name, // 用名字或者全名做标签都可以
        value: v.id,   // 这里使用id作为值，所以拿到的最终地址需要手动转换
    }))

    // var csrf = [[${_csrf.token}]]; // 字符串会自动添加""，数字直接显示
    let params;

    new Vue({
        el: '#app',
        data: {
            activeIndex: '1',
            tableData: [],
            sizeForm: {
                username: 'admin',
                name: '小雪人',
                sex: '男',
                birthday: '2022-07-07',
                email: '',
            },
            address: {
                options0: [],
                options1: [],
                options2: [],
                options3: [],
                value0: '',
                value1: '',
                value2: '',
                value3: '',
                value4: '',
            },
        },
        computed: {
            addressText: function () {
                let result = ''
                if (this.address.value0) {
                    result += this.address.options0.find(v => v.value === this.address.value0).label
                    if (this.address.value1) {
                        result += this.address.options1.find(v => v.value === this.address.value1).label
                        if (this.address.value2) {
                            result += this.address.options2.find(v => v.value === this.address.value2).label
                            if (this.address.value3) {
                                result += this.address.options3.find(v => v.value === this.address.value3).label
                            }
                        }
                    }
                }
                return result + this.address.value4
            },
        },
        methods: {
            handleSelect(key, keyPath) {
                console.log(key, keyPath);
            },
            onSubmit() {
                console.log('submit!');
            },
            change0: function (value) {
                console.log(`change: ${value} -> ${this.address.value0}`)
                this.clear(0)
                if (!value) {
                    return
                }
                let selected = this.address.options0.find((v, i, o) => v.value === value)
                getAddressFromCacheOrNetwork(selected.value)
                    .then(data => this.address.options1 = mapDataToAddress(data))
                    .catch(err => this.$message.error('加载失败，请确认网络正常并刷新重试'))
            },
            change1: function (value) {
                console.log(`change: ${value} -> ${this.address.value0}`)
                this.clear(1)
                if (!value) {
                    return
                }
                let selected = this.address.options1.find((v, i, o) => v.value === value)
                getAddressFromCacheOrNetwork(selected.value)
                    .then(data => this.address.options2 = mapDataToAddress(data))
                    .catch(err => this.$message.error('加载失败，请确认网络正常并刷新重试'))
            },
            change2: function (value) {
                console.log(`change: ${value} -> ${this.address.value0}`)
                this.clear(2)
                if (!value) {
                    return
                }
                let selected = this.address.options2.find((v, i, o) => v.value === value)
                getAddressFromCacheOrNetwork(selected.value)
                    .then(data => this.address.options3 = mapDataToAddress(data))
                    .catch(err => this.$message.error('加载失败，请确认网络正常并刷新重试'))
            },
            clear: function (level) {
                switch (level) {
                    case 0:
                        this.address.options1 = []
                        this.address.value1 = ''
                        this.address.options2 = []
                        this.address.value2 = ''
                        this.address.options3 = []
                        this.address.value3 = ''
                        break
                    case 1:
                        this.address.options2 = []
                        this.address.value2 = ''
                        this.address.options3 = []
                        this.address.value3 = ''
                        break
                    case 2:
                        this.address.options3 = []
                        this.address.value3 = ''
                        break
                    case 3:
                        break
                }
            },
            showAddress: function (i) {
                if (i === 1){
                    this.$confirm(this.addressText, '确认信息').then().catch(e => {})
                    console.log(this.addressText)
                }
            },
        },
        mounted: function () {
            getAddressFromCacheOrNetwork(0)
                .then(data => this.address.options0 = mapDataToAddress(data))
                .catch(err => this.$message.error('加载失败，请确认网络正常并刷新重试'))
        },
    });

</script>
</body>
</html>