<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <link href="../element/css/theme-chalk-2.15.7.css" rel="stylesheet"/>
</head>
<body>
<div id="app">
  <h1>NPlayer在Vue中使用示例</h1>
  <div style="display: flex; flex-direction: column;">
    <header></header>
    <main style="flex: 1; overflow: hidden; display: flex; padding: 2rem; max-height: 60vh;">
      <div style="flex-grow: 1;">
        <n-player ref="player" :options="options" :set="setPlayer"/>
      </div>
      <div style="flex-shrink: 1; flex-basis: 30%; background-color: lightcyan; padding: 1rem; display: flex; flex-direction: column;">
        <div style="flex-grow: 1;">
          <div style="background-color: #5daf34; margin-bottom: 1rem; overflow-y: auto; height: 100%; max-height: 80vh;">
            <div v-if="messageList.length === 0">暂时没有弹幕！</div>
            <div v-else>
              <span v-for="msg of messageList">[{{msg.time}}]: {{msg.text}} - {{msg.userId}}<br/></span>
            </div>
          </div>
        </div>
        <div style="min-height: 1rem; flex-grow: 0;"></div>
        <div style="">
          <el-form :inline="true" style="display: flex; flex-direction: row;">
            <el-form-item style="margin: 0; flex-grow: 1;">
              <el-input style="width: 100%;" v-model="message" @submit.native.prevent :disabled="! isLogin"
                        :placeholder="isLogin ? '输入弹幕' : '登录后发送弹幕'"></el-input>
            </el-form-item>
            <div style="min-width: 8px; flex-shrink: 1; flex-grow: 0;"></div>
            <el-form-item style="margin: 0; flex-grow: 0;">
              <el-button @click="send">发送弹幕</el-button>
            </el-form-item>
          </el-form>
        </div>
      </div>
    </main>
    <el-divider></el-divider>
    <footer>
      <el-row>
        <el-col :span="20" :offset="2">
          <el-button-group>
            <el-button type="primary" @click="loginClick">登录</el-button>
          </el-button-group>
        </el-col>
      </el-row>
    </footer>
  </div>
</div>
<script th:src="@{/js/vue-router.js}" src="../static/js/vue-router.js"></script>



<script th:src="@{/js/vue-2.6.14.min.js}" src="../static/js/vue-2.6.14.min.js"></script>
<script th:src="@{/js/axios-0.26.js}" src="../static/js/axios-0.26.js"></script>
<script th:src="@{/js/axios-0.26.js}" src="../static/js/axios-0.26.js"></script>
<script src="../element/js/element-ui-2.15.7.js"></script>
<!--nplayer脚本-->
<script src="nplayer.min.js"></script>
<script src="danmaku.min.js"></script>
<script src="nplayer_vue_1.0.12.min.js"></script>
<script>
  /*后端API
  * /video/{id} - 打开指定id的视频页面
  * /video/login - AJAX异步登录，测试用
  * /video/{id}/message - 发送消息，发送数据为：BarrageMessageDTO
  * /video/{id}/barrages - 获取数据库中的消息，接收为：List<BarrageMessageDTO>
  * http://localhost:8080
  * */

  /**
   private String text; // 弹幕文字
   private String color; // 弹幕颜色
   private Double time; // 弹幕出现时间
   private Type type; // 弹幕类型，默认滚动
   private Boolean isMe; // 是否是当前用户发送的
   private Boolean force; // 是否强制展示该弹幕
   // 自定义字段
   private Integer userId; // 用户ID
   private Integer movieId; // 哪个视频
   private Long sendTime; // 发送的时间
   private String bgColor; // 弹幕颜色
   */

  let userId = 0 // 这几个字段如果用thymeleaf模板，应该为thymeleaf语法：[[${model的参数}]]
  let movieId = 10 // thymeleaf模板model参数
  let host = 'http://localhost:8080' // 测试用

  Vue.use(NPlayerVue)
  new Vue({
    el: '#app',
    data: {
      player: null,
      danmaku: null,
      options: {
        plugins: [new NPlayerDanmaku({})],
        src: '../video/resource/协程第一话.mp4',
        // 手动配置视频路径
        // this.options.src = '../video/resource/协程第一话.mp4'
        // this.$refs.player.player.updateOptions(this.options)
      },
      // ====================
      messageList: [], // 后端发送的数据，应该按发送时间排序！不是电影时间！
      message: '', // 单条字幕，暂时没用到
      isLogin: false, // 已经登录
    },
    computed: {
      messages: function () {
        return this.messageList && this.messageList.map(v => `${v.userId}: [${parseFloat(v.movieTime).toFixed(2)}] ${v.content}`).join('\n')
      },
      danmakuMessages: function () {
        return this.messageList.sort((a, b) => a.time - b.time)
      },
    },
    methods: {
      setPlayer(player) {
        this.player = player;
        this.danmaku = player.danmaku
        this.player.on('DanmakuSend', msg => {
          this.sendMessage(msg)
        })
        this.player.on(player.danmaku.DANMAKU_UPDATE_OPTIONS, () => {
          console.log(player.danmaku.opts)
        })
      },
      sendMessage(msg) {
        if (! this.isLogin) {
          this.$alert('登录后可以发送消息。')
          return
        }
        // color: "#FFFFFF" force: true isMe: true text: "123" time: 9.747125 type: "scroll"
        if (msg.text.trim() === '') {
          return
        }
        let data = {
          text: msg.text.trim(),
          color: msg.color,
          time: msg.time.toFixed(2),
          type: msg.type,
          isMe: msg.isMe,
          force: msg.force,
          userId: userId,
          movieId: movieId,
          sendTime: new Date().getTime(),
          bgColor: '#ffffff',
        }
        this.messageList.push(data)
        axios.post(`${host}/video/${movieId}/message`, data)
          .then(resp => console.log('发送弹幕成功！', resp.data) || this.$message.success('发送后台成功！'))
          .catch(err => console.log('获取视频的弹幕失败！', err) || this.$message.error('发送后台失败，忽略！'))
      },
      setupWebSocket() {
        if (this.socket) {
          this.socket.close()
        }
        this.socket = new WebSocket(`ws://localhost:8080/ws/${movieId}/${userId}`)
        this.socket.onerror = err => console.log('WebSocket Error', err)
        this.socket.onopen = () => console.log('WebSocket Connected!')
        this.socket.onmessage = event => {
          let message = JSON.parse(event.data)
          // 测试
          this.updateDanmakuMessages(message)
          console.log('收到消息：', message)
          if (message.movieId === movieId && userId !== message.userId) {
            this.messageList.push(message)
          } else {
            console.log('收到一条【恶意】消息（包含用户自己的重复消息）：', message)
          }
        }
      },
      loginNow: function () {
        axios.post(`${host}/video/login`)
          .then(resp => {
            if (resp.data.success) {
              userId = resp.data.userId
              this.isLogin = true
              this.setupWebSocket()
            } else {
              userId = 0
            }
          })
          .catch(err => this.$message.error('登录失败！'))
      },
      loginClick: function () {
        this.$confirm('你要去登录页面登录！现在登录？', '登录', {type: 'info',})
          .then(_ => this.loginNow())
          .catch(_ => this.isLogin = false)
      },
      send() {
        this.$alert('请在视频下方发送弹幕！')
      },
      updateDanmakuMessages(message) {
        const oldItems = this.danmaku.getItems()
        const sortedItems = oldItems.concat(message).sort((a, b) => a.time - b.time)
        this.danmaku.resetItems(sortedItems)
      },
    },
    mounted() {
      axios.defaults.withCredentials = true
      axios.get(`${host}/video/${movieId}/barrages`)
        .then(res => {
          this.messageList = (console.log(res) || res.data)
          this.danmaku.appendItems(this.messageList)
        })
        .catch(err => this.$message.error('获取弹幕失败！'))
      this.setupWebSocket()
    },
  })
</script>
</body>
</html>
